<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .device-table, .mode-table {
            margin-bottom: 30px;
        }
        .table-actions {
            white-space: nowrap;
        }
        .status-active {
            color: #28a745;
        }
        .status-inactive {
            color: #dc3545;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4">üè† Smart Home System</h1>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab">Devices</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="modes-tab" data-bs-toggle="tab" data-bs-target="#modes" type="button" role="tab">Modes</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- –í–∫–ª–∞–¥–∫–∞ Devices -->
            <div class="tab-pane fade show active" id="devices" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Device Management</h5>
                        <button class="btn btn-primary" onclick="showAddDeviceModal()">
                            <i class="fas fa-plus"></i> Add Device
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="deviceTitleFilter" placeholder="Filter by title">
                            </div>
                            <div class="col-md-2">
                                <select class="form-control" id="deviceTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="light">Light</option>
                                    <option value="coffee_machine">Coffee Machine</option>
                                    <option value="speakers">Speakers</option>
                                    <option value="kettle">Kettle</option>
                                    <option value="microwave">Microwave</option>
                                    <option value="door">Door</option>
                                    <option value="conditioner">Conditioner</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-control" id="deviceActivityFilter">
                                    <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary" onclick="loadDevices()">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Power</th>
                                        <th>Status</th>
                                        <th>Mode</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="deviceTableBody">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ Modes -->
            <div class="tab-pane fade" id="modes" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Mode Management</h5>
                        <button class="btn btn-primary" onclick="showAddModeModal()">
                            <i class="fas fa-plus"></i> Add Mode
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- –§–∏–ª—å—Ç—Ä—ã –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="modeTitleFilter" placeholder="Filter by title">
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" id="modeTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="dinner">Dinner</option>
                                    <option value="morning">Morning</option>
                                    <option value="study">Study</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary" onclick="loadModes()">
                                    <i class="fas fa-filter"></i> Filter
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Devices Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="modeTableBody">
                                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Device -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceModalTitle">Add Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceForm">
                        <input type="hidden" id="deviceId">
                        <div class="mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" id="deviceTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type *</label>
                            <select class="form-control" id="deviceType" required>
                                <option value="">Select Type</option>
                                <option value="light">Light</option>
                                <option value="coffee_machine">Coffee Machine</option>
                                <option value="speakers">Speakers</option>
                                <option value="kettle">Kettle</option>
                                <option value="microwave">Microwave</option>
                                <option value="door">Door</option>
                                <option value="conditioner">Conditioner</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Power</label>
                            <input type="number" class="form-control" id="devicePower" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mode</label>
                            <select class="form-control" id="deviceMode">
                                <option value="">No Mode</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="deviceActive">
                            <label class="form-check-label">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDevice()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Mode -->
    <div class="modal fade" id="modeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modeModalTitle">Add Mode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="modeForm">
                        <input type="hidden" id="modeId">
                        <div class="mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" class="form-control" id="modeTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-control" id="modeType">
                                <option value="">Select Type</option>
                                <option value="dinner">Dinner</option>
                                <option value="morning">Morning</option>
                                <option value="study">Study</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMode()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080';
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            loadModes();
            loadModesForDeviceForm();
        });

        // ========== DEVICE FUNCTIONS ==========

        async function loadDevices() {
            try {
                const title = document.getElementById('deviceTitleFilter').value;
                const type = document.getElementById('deviceTypeFilter').value;
                const activity = document.getElementById('deviceActivityFilter').value;
                
                let url = `${API_BASE}/devices/filter?page=0&size=100`;
                if (title) url += `&title=${encodeURIComponent(title)}`;
                if (type) url += `&type=${type}`;
                if (activity) url += `&activity=${activity}`;

                const response = await fetch(url);
                const data = await response.json();
                displayDevices(data.content || data);
            } catch (error) {
                console.error('Error loading devices:', error);
                alert('Error loading devices');
            }
        }

        function displayDevices(devices) {
            const tbody = document.getElementById('deviceTableBody');
            tbody.innerHTML = '';

            devices.forEach(device => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${device.id}</td>
                    <td>${device.title}</td>
                    <td><span class="badge bg-secondary">${device.type}</span></td>
                    <td>${device.power || 'N/A'}</td>
                    <td>
                        <span class="${device.active ? 'status-active' : 'status-inactive'}">
                            <i class="fas ${device.active ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                            ${device.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${device.mode ? device.mode.title : 'No Mode'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editDevice(${device.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice(${device.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddDeviceModal() {
            document.getElementById('deviceModalTitle').textContent = 'Add Device';
            document.getElementById('deviceForm').reset();
            document.getElementById('deviceId').value = '';
            new bootstrap.Modal(document.getElementById('deviceModal')).show();
        }

        async function editDevice(id) {
            try {
                const response = await fetch(`${API_BASE}/devices/${id}`);
                const device = await response.json();
                
                document.getElementById('deviceModalTitle').textContent = 'Edit Device';
                document.getElementById('deviceId').value = device.id;
                document.getElementById('deviceTitle').value = device.title;
                document.getElementById('deviceType').value = device.type;
                document.getElementById('devicePower').value = device.power || '';
                document.getElementById('deviceActive').checked = device.active;
                document.getElementById('deviceMode').value = device.mode ? device.mode.id : '';
                
                new bootstrap.Modal(document.getElementById('deviceModal')).show();
            } catch (error) {
                console.error('Error loading device:', error);
                alert('Error loading device');
            }
        }

        async function saveDevice() {
            const deviceData = {
                title: document.getElementById('deviceTitle').value,
                type: document.getElementById('deviceType').value,
                power: document.getElementById('devicePower').value ? parseFloat(document.getElementById('devicePower').value) : null,
                active: document.getElementById('deviceActive').checked
            };

            const modeId = document.getElementById('deviceMode').value;
            if (modeId) {
                deviceData.mode = { id: parseInt(modeId) };
            }

            const deviceId = document.getElementById('deviceId').value;
            const url = deviceId ? `${API_BASE}/devices/${deviceId}` : `${API_BASE}/devices`;
            const method = deviceId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
                    loadDevices();
                    loadModes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–∏–º—ã, —Ç–∞–∫ –∫–∞–∫ –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å—á–µ—Ç—á–∏–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                } else {
                    alert('Error saving device');
                }
            } catch (error) {
                console.error('Error saving device:', error);
                alert('Error saving device');
            }
        }

        async function deleteDevice(id) {
            if (confirm('Are you sure you want to delete this device?')) {
                try {
                    const response = await fetch(`${API_BASE}/devices/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadDevices();
                        loadModes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∂–∏–º—ã, —Ç–∞–∫ –∫–∞–∫ –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å—á–µ—Ç—á–∏–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    } else {
                        alert('Error deleting device');
                    }
                } catch (error) {
                    console.error('Error deleting device:', error);
                    alert('Error deleting device');
                }
            }
        }

        // ========== MODE FUNCTIONS ==========

        async function loadModes() {
            try {
                const title = document.getElementById('modeTitleFilter').value;
                const type = document.getElementById('modeTypeFilter').value;
                
                let url = `${API_BASE}/modes/filter?page=0&size=100`;
                if (title) url += `&title=${encodeURIComponent(title)}`;
                if (type) url += `&type=${type}`;

                const response = await fetch(url);
                const data = await response.json();
                displayModes(data.content || data);
            } catch (error) {
                console.error('Error loading modes:', error);
                alert('Error loading modes');
            }
        }

        function displayModes(modes) {
            const tbody = document.getElementById('modeTableBody');
            tbody.innerHTML = '';

            modes.forEach(mode => {
                const deviceCount = mode.devices ? mode.devices.length : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mode.id}</td>
                    <td>${mode.title}</td>
                    <td><span class="badge bg-info">${mode.type || 'N/A'}</span></td>
                    <td>
                        <span class="badge ${deviceCount > 0 ? 'bg-success' : 'bg-secondary'}">
                            ${deviceCount} device(s)
                        </span>
                    </td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editMode(${mode.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMode(${mode.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadModesForDeviceForm() {
            try {
                const response = await fetch(`${API_BASE}/modes`);
                const modes = await response.json();
                const select = document.getElementById('deviceMode');
                
                select.innerHTML = '<option value="">No Mode</option>';
                modes.forEach(mode => {
                    const option = document.createElement('option');
                    option.value = mode.id;
                    option.textContent = mode.title;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading modes for device form:', error);
            }
        }

        function showAddModeModal() {
            document.getElementById('modeModalTitle').textContent = 'Add Mode';
            document.getElementById('modeForm').reset();
            document.getElementById('modeId').value = '';
            new bootstrap.Modal(document.getElementById('modeModal')).show();
        }

        async function editMode(id) {
            try {
                const response = await fetch(`${API_BASE}/modes/${id}`);
                const mode = await response.json();
                
                document.getElementById('modeModalTitle').textContent = 'Edit Mode';
                document.getElementById('modeId').value = mode.id;
                document.getElementById('modeTitle').value = mode.title;
                document.getElementById('modeType').value = mode.type || '';
                
                new bootstrap.Modal(document.getElementById('modeModal')).show();
            } catch (error) {
                console.error('Error loading mode:', error);
                alert('Error loading mode');
            }
        }

        async function saveMode() {
            const modeData = {
                title: document.getElementById('modeTitle').value,
                type: document.getElementById('modeType').value || null
            };

            const modeId = document.getElementById('modeId').value;
            const url = modeId ? `${API_BASE}/modes/${modeId}` : `${API_BASE}/modes`;
            const method = modeId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(modeData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modeModal')).hide();
                    loadModes();
                    loadModesForDeviceForm(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∂–∏–º–æ–≤ –≤ —Ñ–æ—Ä–º–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                } else {
                    alert('Error saving mode');
                }
            } catch (error) {
                console.error('Error saving mode:', error);
                alert('Error saving mode');
            }
        }

        async function deleteMode(id) {
            if (confirm('Are you sure you want to delete this mode? This will remove it from all associated devices.')) {
                try {
                    const response = await fetch(`${API_BASE}/modes/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadModes();
                        loadModesForDeviceForm(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∂–∏–º–æ–≤ –≤ —Ñ–æ—Ä–º–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                        loadDevices(); // –û–±–Ω–æ–≤–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ç–∞–∫ –∫–∞–∫ –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Ä–µ–∂–∏–º
                    } else {
                        alert('Error deleting mode');
                    }
                } catch (error) {
                    console.error('Error deleting mode:', error);
                    alert('Error deleting mode');
                }
            }
        }
    </script>
</body>
</html>